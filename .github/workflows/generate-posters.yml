name: ğŸ—ºï¸ Generate Map Posters and Thumbnails

on:
  push:
    paths:
      - 'mexico_cities_full.txt'
      - '.github/workflows/generate-posters.yml'
  workflow_dispatch: # Allow manual triggering

# Prevent multiple poster generation workflows from running simultaneously
concurrency:
  group: poster-generation
  cancel-in-progress: true

jobs:
  generate-posters:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Needed to push back to the repository
      pages: write       # Needed to trigger GitHub Pages builds
      id-token: write    # Needed for OIDC authentication
      deployments: read  # Needed to check deployment status

    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch full history for proper git operations

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # Use a stable version for CI

    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgdal-dev \
          libproj-dev \
          libgeos-dev \
          libspatialindex-dev \
          libssl-dev \
          libffi-dev \
          libjpeg-dev \
          libpng-dev \
          libfreetype6-dev \
          fonts-dejavu-core

    - name: ï¿½ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ï¿½ğŸ“š Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ“Š Check Changes in Cities File
      id: check-changes
      run: |
        if git diff --name-only HEAD~1 | grep -q "mexico_cities_full.txt"; then
          echo "cities_changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Cities file changed, will generate new posters"
        else
          echo "cities_changed=false" >> $GITHUB_OUTPUT
          echo "âšª No changes in cities file, running anyway (manual trigger or workflow change)"
        fi

    - name: ğŸ—ºï¸ Generate Map Posters
      env:
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ Starting poster generation process..."
        python generate_all_mexico_posters.py
        echo "âœ… Poster generation completed!"

    - name: ğŸ–¼ï¸ Generate Thumbnails
      run: |
        echo "ğŸ–¼ï¸ Generating optimized thumbnails..."
        python generate_thumbnails.py
        echo "âœ… Thumbnail generation completed!"

    - name: ğŸ“ Check Generated Files
      run: |
        echo "ğŸ“Š Poster files in posters/ directory:"
        ls -la posters/ | wc -l
        echo "ğŸ–¼ï¸ Thumbnail files in thumbnails/ directory:"
        ls -la thumbnails/ | wc -l
        echo "ğŸ“„ Gallery metadata:"
        if [ -f "posters-list.json" ]; then
          echo "âœ… posters-list.json exists"
          wc -l posters-list.json
        else
          echo "âŒ posters-list.json missing"
        fi

    - name: ğŸ” Check Git Status
      run: |
        git status
        git diff --name-only

    - name: ğŸ“ Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ğŸ’¾ Commit and Push Changes
      id: commit-changes
      run: |
        # Add all generated files
        git add posters/ thumbnails/ posters-list.json
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âšª No new files to commit"
          echo "changes_made=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ Committing new posters and thumbnails..."
          
          # Count new files
          NEW_POSTERS=$(git diff --staged --name-only | grep "^posters/" | wc -l)
          NEW_THUMBNAILS=$(git diff --staged --name-only | grep "^thumbnails/" | wc -l)
          
          # Create commit message
          COMMIT_MSG="ğŸ¤– Auto-generate posters and thumbnails

          ğŸ—ºï¸ Generated $NEW_POSTERS new poster(s)
          ğŸ–¼ï¸ Generated $NEW_THUMBNAILS new thumbnail(s)
          ğŸ“„ Updated gallery metadata
          
          Triggered by: ${{ github.event_name }}
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… Successfully pushed new posters and thumbnails!"
          echo "changes_made=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸŒ Trigger GitHub Pages Deployment
      uses: actions/github-script@v7
      continue-on-error: true  # Don't fail the workflow if Pages API is unavailable
      with:
        script: |
          console.log('ğŸŒ Triggering GitHub Pages deployment...');
          
          try {
            const response = await github.rest.repos.requestPagesBuild({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            console.log('âœ… GitHub Pages build triggered successfully!');
            console.log(`ğŸ“Š Status: ${response.status}`);
            return true;
          } catch (error) {
            console.log('âš ï¸ Could not trigger Pages build directly:', error.message);
            console.log('ğŸ“ GitHub Pages will auto-rebuild from the push to main branch');
            console.log('ğŸ”— Manual deployment can be triggered at:');
            console.log(`   https://github.com/${context.repo.owner}/${context.repo.repo}/settings/environments`);
            return false;
          }

    - name: â³ Wait for GitHub Pages Deployment
      uses: actions/github-script@v7
      continue-on-error: true  # Don't fail workflow if deployment checking fails
      with:
        script: |
          console.log('â³ Waiting for GitHub Pages deployment to complete...');
          
          const maxWaitTime = 3 * 60 * 1000; // Reduced to 3 minutes
          const checkInterval = 10 * 1000;   // Check every 10 seconds
          const startTime = Date.now();
          
          let deploymentFound = false;
          
          while (Date.now() - startTime < maxWaitTime) {
            try {
              // Get recent deployments for github-pages environment
              const deployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment: 'github-pages',
                per_page: 5  // Check last 5 deployments
              });
              
              if (deployments.data.length > 0) {
                // Find the most recent deployment
                const recentDeployment = deployments.data[0];
                
                // Check deployment status
                const statuses = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: recentDeployment.id,
                  per_page: 1
                });
                
                if (statuses.data.length > 0) {
                  const latestStatus = statuses.data[0];
                  console.log(`ğŸ“Š Deployment status: ${latestStatus.state}`);
                  deploymentFound = true;
                  
                  if (latestStatus.state === 'success') {
                    console.log('âœ… GitHub Pages deployed successfully!');
                    console.log(`ğŸŒ Site URL: https://${context.repo.owner}.github.io/${context.repo.repo}`);
                    break;
                  } else if (latestStatus.state === 'failure' || latestStatus.state === 'error') {
                    console.log('âŒ GitHub Pages deployment failed');
                    console.log(`ğŸ” Check details: https://github.com/${context.repo.owner}/${context.repo.repo}/deployments`);
                    break;
                  } else if (latestStatus.state === 'in_progress' || latestStatus.state === 'pending') {
                    console.log('â³ Deployment in progress...');
                  }
                }
              }
              
              // Wait before next check
              await new Promise(resolve => setTimeout(resolve, checkInterval));
              
            } catch (error) {
              console.log('âš ï¸ Error checking deployment status:', error.message);
              console.log('ğŸ”— Check deployment status manually at:');
              console.log(`   https://github.com/${context.repo.owner}/${context.repo.repo}/deployments`);
              break;
            }
          }
          
          if (!deploymentFound) {
            console.log('ğŸ“ No deployments found yet. GitHub Pages should deploy automatically.');
          }
          
          console.log('ğŸ”— Monitor deployment status at:');
          console.log(`   https://github.com/${context.repo.owner}/${context.repo.repo}/deployments`);
          console.log('ğŸŒ Your site will be available at:');
          console.log(`   https://${context.repo.owner}.github.io/${context.repo.repo}`);

    - name: ğŸ‰ Summary
      run: |
        echo "ğŸ‰ Workflow completed successfully!"
        echo "ğŸ“Š Total posters: $(ls posters/*.png 2>/dev/null | wc -l)"
        echo "ğŸ–¼ï¸ Total thumbnails: $(ls thumbnails/*.jpg 2>/dev/null | wc -l)"
        echo "ğŸŒ Gallery updated and ready!"
        echo ""
        echo "ğŸ”— Your gallery is available at:"
        echo "   https://originalankur.github.io/maptoposter"
        echo ""
        echo "ğŸ“± Changes should be live within a few minutes!"