name: ğŸ—ºï¸ Generate Map Posters and Thumbnails

on:
  push:
    paths:
      - 'mexico_cities_full.txt'
      - '.github/workflows/generate-posters.yml'
  workflow_dispatch: # Allow manual triggering

# Prevent multiple poster generation workflows from running simultaneously
concurrency:
  group: poster-generation
  cancel-in-progress: true

jobs:
  generate-posters:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Needed to push back to the repository
      pages: write       # Needed to trigger GitHub Pages builds
      id-token: write    # Needed for OIDC authentication
      deployments: read  # Needed to check deployment status

    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch full history for proper git operations

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # Use a stable version for CI

    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgdal-dev \
          libproj-dev \
          libgeos-dev \
          libspatialindex-dev \
          libssl-dev \
          libffi-dev \
          libjpeg-dev \
          libpng-dev \
          libfreetype6-dev \
          fonts-dejavu-core

    - name: ï¿½ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ï¿½ğŸ“š Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ“Š Check Changes in Cities File
      id: check-changes
      run: |
        if git diff --name-only HEAD~1 | grep -q "mexico_cities_full.txt"; then
          echo "cities_changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Cities file changed, will generate new posters"
        else
          echo "cities_changed=false" >> $GITHUB_OUTPUT
          echo "âšª No changes in cities file, running anyway (manual trigger or workflow change)"
        fi

    - name: ğŸ—ºï¸ Generate Map Posters
      env:
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ Starting poster generation process..."
        python generate_all_mexico_posters.py
        echo "âœ… Poster generation completed!"

    - name: ğŸ–¼ï¸ Generate Thumbnails
      run: |
        echo "ğŸ–¼ï¸ Generating optimized thumbnails..."
        python generate_thumbnails.py
        echo "âœ… Thumbnail generation completed!"

    - name: ğŸ“ Check Generated Files
      run: |
        echo "ğŸ“Š Poster files in posters/ directory:"
        ls -la posters/ | wc -l
        echo "ğŸ–¼ï¸ Thumbnail files in thumbnails/ directory:"
        ls -la thumbnails/ | wc -l
        echo "ğŸ“„ Gallery metadata:"
        if [ -f "posters-list.json" ]; then
          echo "âœ… posters-list.json exists"
          wc -l posters-list.json
        else
          echo "âŒ posters-list.json missing"
        fi

    - name: ğŸ” Check Git Status
      run: |
        git status
        git diff --name-only

    - name: ğŸ“ Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ğŸ’¾ Commit and Push Changes
      id: commit-changes
      run: |
        # Add all generated files
        git add posters/ thumbnails/ posters-list.json
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âšª No new files to commit"
          echo "changes_made=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ Committing new posters and thumbnails..."
          
          # Count new files
          NEW_POSTERS=$(git diff --staged --name-only | grep "^posters/" | wc -l)
          NEW_THUMBNAILS=$(git diff --staged --name-only | grep "^thumbnails/" | wc -l)
          
          # Create commit message
          COMMIT_MSG="ğŸ¤– Auto-generate posters and thumbnails

          ğŸ—ºï¸ Generated $NEW_POSTERS new poster(s)
          ğŸ–¼ï¸ Generated $NEW_THUMBNAILS new thumbnail(s)
          ğŸ“„ Updated gallery metadata
          
          Triggered by: ${{ github.event_name }}
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… Successfully pushed new posters and thumbnails!"
          echo "changes_made=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“¦ Upload GitHub Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ‰ Summary
      run: |
        echo "ğŸ‰ Workflow completed successfully!"
        echo "ğŸ“Š Total posters: $(ls posters/*.png 2>/dev/null | wc -l)"
        echo "ğŸ–¼ï¸ Total thumbnails: $(ls thumbnails/*.jpg 2>/dev/null | wc -l)"
        echo "ğŸŒ Site deployed to GitHub Pages!"
        echo ""
        echo "ğŸ”— Your gallery is available at:"
        echo "   https://originalankur.github.io/maptoposter"
        echo ""
        echo "ğŸ“± Changes should be live within a few minutes!"
        echo "ğŸ” Check deployment status at:"
        echo "   https://github.com/originalankur/maptoposter/deployments"